# 目标导向行为计划简介 Introduction to GOAP

## 什么是GOAP?
`GOAP`指`Goal-orientated Action Planning`，即目标导向行为计划。顾名思义，应用了`GOAP`系统的行为将由目标来决定（计划）和执行。

## GOAP跟之前的行为树和有限状态机是什么关系？
不同于行为树`Behavior Trees`，所有定义的行为`Action`在`GOPA`中为自由元素，可看作一个行为池，并没有使用`图`进行链接。这意味着定义和添加新的行为会非常容易和灵活。换句话说，`GOAP`的实现与行为树没有任何关系，既不是从属也不是进化关系，而是两套平行的AI方案，各有更合适的业务场景。比如一个极其简单的AI就没有必要使用`GOAP`系统。

`GOAP`中也有使用有限状态机`FSM`，不过仅仅在执行移动和实施行为时使用，没有复杂的图和状态触发条件，可以理解为管走路和动画。

## GOAP的系统结构和工作逻辑原理是什么？
`GOAP`的实现需要四大元素，分别是行为`Action`、目标`Goals`，世界环境状态`World State`和计划器`Planner`。整个系统中，行为、目标、世界状态作为输入输入到计划器中，计划器根据输入的信息，使用某些算法（A星算法`A* algorithm`，或其他算法）输出一套行为队列（行为集）。其中

### 行为 Action
不同于行为树`Behavior Trees`，`GOAP`中的行为`Action`之间没有直接联系，呈松耦合状态。既然是松耦合，那么结构中一定有接口设计。行为`Action`可看作由两个输入输出单向接口加上执行核心三部分组成的小系统，其中输入接口我们称之为先决条件`preconditions`，输出接口为影响效果`effects`，执行核心就是行为本身。

当一个行为产生的效果影响能按自定义规则（比如完全相等，定义规则在计划器算法中实现）匹配上另一个行为的先决条件，那么这两个行为就可以被算法链接起来（放到一个按顺序执行的队列`Queue`中）。一个行为可以只有先决条件，也可以只有影响，大部分情况是两者都有，但不能两者都没有，否则没有意义。先决条件和影响可以只有一个，也可以有多个，在行为系统中以键值对类型的哈希表储存和输出。

执行`perform`行为部分除了执行行为本身，还需要返回执行状态信息，如执行成功与否。这个状态信息在其他部分，通常是动画、状态机，会用到。

>> 比如，泡面这一行为可以分解为烧水、泡面两个行为。烧水这个行为的前置条件就是电热水壶里有水，行为执行内容为打开电热水壶开关，行为效果为获得热水；泡面行为的前提条件是有泡面和有热水，行为执行内容为将热水壶里的水倒入泡面碗，效果为得到一碗能吃的面。

### 目标 Goals
目标可以在任何地方由任何脚本提供，只要符合规则格式（通常是键值对的哈希表），并且想办法提供给计划器（通常是通过带接口`IGoap`的对象提供）即可。

>> 比如，吃泡面就可以看作是一个目标，可以由一个人物对象（中的某一个脚本组件）提供。

### 世界状态 World State
基本上世界状态就是一个提供信息参数的对象。这个对象可以被视为环境系统的一部分，用于收集任何有可能对AI产生影响的数据。将这些数据提供给计划器，可获得行为执行队列。

>> 比如，水壶里本来就有水，桌上本来就有一碗没开封的泡面这两条信息就是世界状态的一部分。

### 计划器 Planner
计划器是`GOAP`系统的核心，可以将输入的参数（行为池、目标、世界状态）转化为可执行的计划队列，输出给状态机执行。实现原理为`A* Algorithm`或其他改进、自定义算法。就拿`A* Algorithm`举例，整个流程可以看作为逆向溯源。首先从目标键值对开始，在行为池中搜索是否有能产生这种效果的行为，如果有则添加到可执行行为队列，再继续从行为池中搜索能满足该行为前提条件的其他行为，如此循环，直到搜索到没有前提条件或世界状态就能提供前提条件为止。此时行为队列就是执行队列。在这个过程中，可能会产生不止一条可执行队列，`A* Algorithm`会通过权重调节的方式，确保只有一条队列输出。

>> 比如，目标是吃面，行为池中的信息能组成两条潜在的执行队列，一条为泡面，一条是定外卖。算法会比较两者的花费`cost`，包括时间花费和金钱花费，计算出调节权重，最终选择权重高的一条（自己泡，便宜）。

值得一提的是，在计算调节权重的时候，直接成本不一定是固定唯一的考虑项。如果要做出拟人、情绪化的AI，情绪系统、虚拟大脑奖励系统的输出可以作为间接成本计算加入总成本，最终影响权重调整。

>> 比如，虽然自己泡面很便宜，定外卖贵，但是考虑到今儿心情不好，亲自泡面成本受到虚拟大脑奖励系统的加成，最终导致成本陡然升高，远远高于定外卖，所以心情不好的AI会选择定外卖。

## 计划器应该放在什么地方实现？
通常都在xx管理器`xxManager`中实现某一批脚本中互相调用方法。`GOAP`系统也不例外，通常将集成了`GOAP`系统脚本的对象称为`GOAPAgent`。只用将这个`GOAPAgent`作为组件再加上其他一些提供参数的必备组件添加到AI对象`agent`中即可实现`GOAP`系统。

最后更新20210302
